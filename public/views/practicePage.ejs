<!doctype html>
<html lang="en" id="practice-html">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Caveat&family=Poppins&family=Recursive&family=Belgrano&family=Bellota&family=Handlee&family=Rye&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <!-- bootstrap5-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="styles/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <title>Hanford Lam | Piano Teacher</title>
    <!-- CURSOR -->
    <style>HTML,BODY{cursor: url("../../images/cursor.cur"), auto;}</style>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-S7KLNXVSDD"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-S7KLNXVSDD');
    </script>
  </head>
  <body class="container-fluid background-transparent">
    <!-- NAVBAR -->
    <nav id="myNav" class="rounded recursive row align-items-center text-center py-2 w-auto">
      <div class="col-lg-5">
        <a id="navIcon" class="my-2 d-block" href='/'>Hanford Lam | Piano Teacher</a>
      </div>
      <div class="col-lg-7">
        <a id="practiceTab" href="/practice" class="mx-4 my-2 d-inline-block navLink">PRACTICE</a>
        <a id="missionsTab" href="/missions" class="mx-4 my-2 d-inline-block navLink">MISSIONS</a>
        <a id="leaderboardTab" href="/leaderboard" class="mx-4 my-2 d-inline-block navLink">LEADERBOARD</a>
        <form id="logoutButton" class="mx-4 my-2 d-inline-block" action="/logout" method="POST">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <button type="submit" class="btn btn-sm btn-secondary">LOG OUT</button>
        </form>        
      </div>
    </nav>
    

      <!-- DYNAMIC NAVBAR AND TITLE -->
      <script>
        let currentPath = window.location.pathname
        if (currentPath == '/practice') {
          document.getElementById("practiceTab").classList.add("orange-text")
          document.title = "Portal - Hanford Lam"
        } else if (currentPath == '/missions') {
          document.getElementById("missionsTab").classList.add("orange-text")
          document.title = "Portal - Hanford Lam"
        } else if (currentPath == '/leaderboard') {
          document.getElementById("leaderboardTab").classList.add("orange-text")
          document.title = "Portal - Hanford Lam"
        }
      </script>
      <div id="container" class="container">
        <!-- ERRORS -->
        <% adErrors.forEach(function(message) { %>
          <div class="alert alert-danger text-center small py-1 mt-2"><%= message %></div>
        <% }) %>

        <!--WALLET-->
        <%- include('includes/wallet') %>

        <!-- PRACTICE HUB -->
        <!-- linebreaks are rendered in textarea placeholder -->
        <div id="practice-guide" class="aboveFalling transparentBG mt-2 mb-4 section">
          <div class="py-4 my-4 mb-2 mx-0">
            <!--DISPLAY WEEKLY COMMENTS-->
            <% latestComments.forEach((comment) => { %>
              <div id="weeklySnapshot" class="mt-0 px-5 py-4 mt-4 rounded recursive"><%- filterUserHTML(comment.comments) %></div>  
              <div id="print-button" class="text-center mt-3 pt-3 pb-2">
                <button class="mx-3 my-5 btn btn-secondary btn-sm" href="#" onclick="printDiv('weeklySnapshot')">Print notes</button>
              </div>
            <% }) %>
            <!--RECORDED LESSON-->
            <div id="recordedLesson" class="aboveFalling mb-5 rounded">
              <% if(recordedLessonURL){ %>
              <div class="responsive-container">
                <iframe loading="lazy" style="z-index: 99999;" class="" width="100%" height="500px" src="https://www.youtube.com/embed/<%= recordedLessonURL %>" title="Latest lesson recording" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
              </div>
              <% } %>
            </div>
            <!-- keep csrf token accessible, use lowercase for dataset entries! -->
            <span id="csrf-landmark" data-value="<%= csrfToken %>" data-username="<%= username %>" data-studentid="<%= userId %>"></span>
            <span id="guessTheTempo"></span>
            <!-- Guess the Tempo -->
            <% if (BPMStatus == 'success') { %>
              <div id="bpm-success" class="aboveFalling green-text text-center mb-4 mt-4 pt-4">
                <img src='../images/metronome-colour.png' alt='blinking!' id='blinking_image' class="mb-4 d-block mx-auto"/>
                <p class="black-bg d-inline-block p-3 rounded">Spot on, <%= randomBPM %>! Your sense of timing is amazing.
                <br>The Piano Wizard has put some points in your wallet.</p>
              </div>
            <% } else if (BPMStatus == 'notQuite') { %>
              <div id="bpm-almost" class="aboveFalling pink-text text-center mb-4 mt-4 pt-4">
                <img src='../images/metronome-colour.png' alt='blinking!' id='blinking_image' class="mb-4 d-block mx-auto"/>
                <p class="black-bg d-inline-block p-3 rounded">Not quite! The tempo is <%= randomBPM %> beats per minute.<br>
                The Piano Wizard has put some points in your wallet.</p>
              </div>
            <% } else { %>
              <div class="d-flex justify-content-center">
                <form action="/guessBPM" method="POST" style="background-color: rgba(0, 0, 0, 0.775);" class="aboveFalling form-inline d-inline-block text-center rounded p-4 mb-4 mt-4 justify-content-center">
                  <p class="white-text caveat" style="font-size: 2em;">Guess the Tempo</p>
                  <img src='../images/metronome-colour.png' alt='blinking!' id='blinking_image' />
                <div class="form-group ml-4 mt-3">
                  <input type="range" min="20" max="200" step="10" name="bpmGuess" id="bpmGuess" class="input-lg mx-sm-3" oninput="num.value = this.value">
                  <output style="width:3rem;" class="mr-0 pr-0 white-text" id="num">110</output>
                  <small id="passwordHelpInline" class="text-muted">
                    beats per minute
                  </small>
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <button type="submit" class="btn btn-success ms-3">Guess</button>
                </div>
              </form>
              </div>
              
            <% } %>
            <script>
              // Guess the tempo
              var img = document.getElementById('blinking_image');

              var interval = window.setInterval(function(){
                if (img.style.visibility == 'hidden') {
                  img.style.visibility = 'visible';
                } else{
                  img.style.visibility = 'hidden';
                }
              }, 30000/<%- randomBPM %>);
            </script>
            <!--DISPLAY CONVERSATION-->
            <div id="practiceConversationContainer" class="w-100 d-flex topShadow rounded mb-5" style="z-index: -2;overflow-y: auto;height:300px;">
              <div id="practiceConversation" class="mx-auto pt-4 px-4" style="z-index: -1;">
                <% practiceConversation.forEach((entry) => { 
                  if(entry[0] == 'You') { %>
                    <p class="black-text p-2 rounded" style="background-color: rgba(255, 255, 255, 0.912)"><strong class="orange-text"><%= entry[0] %></strong> : <%= entry[1] %></p>
                  <% } else if(entry[0] == 'Hanford') { %>
                    <p class="black-text p-2 rounded" style="background-color: rgba(255, 255, 255, 0.912)"><strong class="purple-text"><%= entry[0] %></strong> : <%= entry[1] %></p>
                  <% }
                }) %>
              </div>
            </div>
            <script>
              let practiceConversationContainer = document.getElementById('practiceConversationContainer')
              practiceConversationContainer.scrollTop = practiceConversationContainer.scrollHeight
            </script>
            <!--DISPLAY REPLY BOX IF NO PRACTICE STATUS-->
            <% if (!practiceStatus) { %>
              <form id="PracticeConvo" class="my-2" action="/updateLastSubmittedDateAndAddPoints" method="POST">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <div class="form-group text-center" style="width:100%;margin:0 auto;">
                  <textarea autocomplete="off" name="practiceConversation" class="form-control" style="background-color: rgba(30, 20, 51, 0.529);color:chartreuse;" 
                  placeholder="<%= practicePrompt %>&#10; &#10;" id="practiceConversation" rows="6"></textarea>
                  <button  type="submit" class="btn btn-info btn-lg mt-4" style="font-size: 1.2rem;">SEND</button>
                </div>
              </form>
            <% } else { %>
              <div id="practice-success" class="recursive text-center mt-5 my-2">
                <p class="black-bg d-inline-block p-3 rounded"><span class="green-text">Come back tomorrow for Hanford's reply!</span><br><span class="orange-text">Some points have been added to your wallet.</span></p>
              </div>
            <% } %>
          </div>
        </div>

        <script>
          // PRINT FEATURE PLAIN TEXT
          function printDiv(elementId) {
            var prtContent = document.getElementById(elementId);
            var WinPrint = window.open('', '', 'left=0,top=0,width=800,height=900,toolbar=0,scrollbars=0,status=0');
            WinPrint.document.write(prtContent.innerHTML);
            WinPrint.document.close();
            WinPrint.focus();
            WinPrint.print();
          }

          // prevent multisubmits
          try {
            (function() {
              let frm = document.getElementById("PracticeConvo")
              var allowSubmit = true;
              frm.onsubmit = function () {
                if (allowSubmit)
                    allowSubmit = false;
                else 
                    return false;
              }
            })();
          } catch(err) {
            console.log(err);
          }
        </script>

        <script>
          // DRAGGABLE WALLET
          var dragItem = document.querySelector(".draggable");
          var container = document.querySelector("#container");

          var active = false;
          var currentX;
          var currentY;
          var initialX;
          var initialY;
          var xOffset = 0;
          var yOffset = 0;

          container.addEventListener("touchstart", dragStart, false);
          container.addEventListener("touchend", dragEnd, false);
          container.addEventListener("touchmove", drag, false);

          container.addEventListener("mousedown", dragStart, false);
          container.addEventListener("mouseup", dragEnd, false);
          container.addEventListener("mousemove", drag, false);

          function dragStart(e) {
            if (e.type === "touchstart") {
              initialX = e.touches[0].clientX - xOffset;
              initialY = e.touches[0].clientY - yOffset;
            } else {
              initialX = e.clientX - xOffset;
              initialY = e.clientY - yOffset;
            }

            if (e.target === dragItem) {
              active = true;
            }
          }

          function dragEnd(e) {
            initialX = currentX;
            initialY = currentY;

            active = false;
          }

          function drag(e) {
            if (active) {
            
              e.preventDefault();
            
              if (e.type === "touchmove") {
                currentX = e.touches[0].clientX - initialX;
                currentY = e.touches[0].clientY - initialY;
              } else {
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
              }

              xOffset = currentX;
              yOffset = currentY;

              setTranslate(currentX, currentY, dragItem);
            }
          }

          function setTranslate(xPos, yPos, el) {
            el.style.transform = "translate3d(" + xPos + "px, " + yPos + "px, 0)";
          }

          // rainbow headings
            window.addEventListener("load", function() {
            let elements = document.getElementsByClassName("rainbowText");
            for (let i = 0; i < elements.length; i++) {
              generateRainbowText(elements[i]);
            }
          })
          
          function generateRainbowText(element) {
            let text = element.innerText;
            element.innerHTML = "";
            for (let i = 0; i < text.length; i++) {
              let charElem = document.createElement("span");
              charElem.style.color = "hsl(" + (360 * i / text.length) + ",100%,50%)";
              charElem.style.fontWeight = "bold";
              charElem.style.textShadow = "0px 4px 5px hsl(" + (360 * i / text.length) + ",80%,20%), 4px 0px 5px hsl(" + (360 * i / text.length) + ",80%,20%), -4px 0px 5px hsl(" + (360 * i / text.length) + ",80%,20%), 0px -4px 5px hsl(" + (360 * i / text.length) + ",80%,20%)";
              charElem.innerHTML = text[i];
              element.appendChild(charElem);
            }
          }
        
        </script>
    

      <!-- Footer -->
      <footer class="footer text-center small white-text py-3">
          <p class="m-0 raleway">Copyright &copy; <script>document.write(new Date().getFullYear());</script> <a href='/' class="white-text raleway">hanfordlam.com</a>. All rights reserved.</p>
          <p class="m-0">Background drawn by sweetcutiepie</p>
      </footer>
    </div> <!-- close out page container div -->
    <!-- BOOTSTRAP 5 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="../../main-bundled.js"></script>
  </body>
</html>